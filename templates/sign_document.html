{% extends "base.html" %}
{% block content %}
<form method="post" onsubmit="return saveSignature()">
    <div class="bottom-text">
        Draw your signature to approve this transfer.
    </div>

    <div class="signature-box">
        <canvas id="sigCanvas"></canvas>
        <div class="signature-hint">Sign here</div>
    </div>

    <input type="hidden" id="signature_data" name="signature_data">

    <button type="button" class="secondary" onclick="clearSignature()">Retry</button>
    <button type="submit" class="primary">Next</button>
</form>

<script>
    let canvas = document.getElementById('sigCanvas');
    let ctx = canvas.getContext('2d');
    let drawing = false;

    function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width - 2;
        canvas.height = rect.height - 2;
        ctx.fillStyle = "#181818";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    window.addEventListener('load', resizeCanvas);
    window.addEventListener('resize', resizeCanvas);

    canvas.addEventListener('mousedown', function (e) {
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('mousemove', function (e) {
        if (!drawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.stroke();
    });

    canvas.addEventListener('mouseup', function () {
        drawing = false;
    });

    canvas.addEventListener('mouseleave', function () {
        drawing = false;
    });

    function clearSignature() {
        ctx.fillStyle = "#181818";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function saveSignature() {
        let dataUrl = canvas.toDataURL("image/png");
        document.getElementById('signature_data').value = dataUrl;
        if (!dataUrl) {
            alert("Please draw your signature.");
            return false;
        }
        return true;
    }
</script>
{% endblock %}
